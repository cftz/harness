---
name: finalize-implement
description: |
  Finalizes implementation by committing, pushing, creating PR, and updating Linear issue state.

  Args:
    ISSUE_ID=<id> (Required) - Linear Issue ID to update state
    Options:
      AUTO_ACCEPT=true - Skip user approval (default: false)
      BASE_BRANCH=<name> - Base branch for PR target (default: main)

  Examples:
    /finalize-implement ISSUE_ID=TA-123
    /finalize-implement ISSUE_ID=TA-123 AUTO_ACCEPT=true
    /finalize-implement ISSUE_ID=TA-123 BASE_BRANCH=develop
model: claude-sonnet-4-5
context: fork
agent: step-by-step-agent
---

# Finalize Implement Skill

Atomic skill for finalizing implementation after code review passes. Performs git operations (commit, push, PR creation) and updates Linear issue state. All operations are idempotent - safe to re-run without side effects.

## Parameters

### Required

- `ISSUE_ID` - Linear Issue ID to update state (e.g., `TA-123`)

### Optional

- `AUTO_ACCEPT` - If `true`, skip user approval. Defaults to `false`.
- `BASE_BRANCH` - Base branch for determining branch type and PR target. Defaults to `main`.

## Usage Examples

```bash
# Basic usage with user approval
skill: finalize-implement
args: ISSUE_ID=TA-123

# Skip user approval (for workflow automation)
skill: finalize-implement
args: ISSUE_ID=TA-123 AUTO_ACCEPT=true

# Custom base branch
skill: finalize-implement
args: ISSUE_ID=TA-123 BASE_BRANCH=develop
```

## Workflow Overview

```
┌─────────────────────────────────────────────────────────────┐
│  Step 1: Validate Parameters                                │
│  - Verify ISSUE_ID is provided                              │
│  - Set defaults for optional params                         │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 2: User Approval (skip if AUTO_ACCEPT=true)           │
│  - Show summary of pending operations                       │
│  - Request confirmation                                     │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 3: Detect Branch Type                                 │
│  - Get current branch name                                  │
│  - Compare with BASE_BRANCH                                 │
│  - Determine: feature branch or default branch              │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 4: Git Operations (idempotent)                        │
│  ┌────────────────────────────────────────────────────────┐│
│  │ 4.1. Check uncommitted changes                         ││
│  │      → If changes exist: Create commit                 ││
│  │      → If no changes: Skip (already committed)         ││
│  │                                                        ││
│  │ 4.2. Check unpushed commits                            ││
│  │      → If unpushed: Push to remote                     ││
│  │      → If synced: Skip (already pushed)                ││
│  │                                                        ││
│  │ 4.3. [Feature branch only] Check PR exists             ││
│  │      → If no PR: Create PR to BASE_BRANCH              ││
│  │      → If PR exists: Skip (already created)            ││
│  └────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 5: Update Linear Issue State                          │
│  - Feature branch → "In Review"                             │
│  - Default branch → "Done"                                  │
│  (Skip if already in target state)                          │
└─────────────────────────────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────┐
│  Step 6: Report Result                                      │
│  - Summary of operations performed                          │
│  - PR URL (if created)                                      │
│  - Final issue state                                        │
└─────────────────────────────────────────────────────────────┘
```

## Process

### 1. Validate Parameters

1. Verify `ISSUE_ID` is provided
   - If missing: Report error and abort
2. Set defaults:
   - `AUTO_ACCEPT` defaults to `false`
   - `BASE_BRANCH` defaults to `main`

### 2. User Approval

> Skip this step if `AUTO_ACCEPT=true`

1. Gather information to show user:
   - Current branch name
   - Uncommitted changes (if any)
   - Unpushed commits count (if any)
   - Target Linear state

2. Present summary and ask for approval:
   ```
   AskUserQuestion:
     question: "Ready to finalize implementation. Proceed with commit, push, and Linear update?"
     header: "Finalize"
     options:
       - label: "Proceed"
         description: "Commit changes, push to remote, update Linear issue"
       - label: "Cancel"
         description: "Abort finalization"
   ```

3. If user selects **Cancel**: Abort with message "Finalization cancelled by user"

### 3. Detect Branch Type

1. Get current branch:
   ```bash
   git branch --show-current
   ```

2. Compare with `BASE_BRANCH`:
   - If current branch == BASE_BRANCH → **Default branch mode**
   - If current branch != BASE_BRANCH → **Feature branch mode**

3. Store branch type for subsequent steps

### 4. Git Operations (Idempotent)

Execute each sub-step with idempotency checks:

#### 4.1. Commit Changes

1. Check for uncommitted changes:
   ```bash
   git status --porcelain
   ```

2. If output is empty:
   - Log: "No uncommitted changes, skipping commit"
   - Continue to next step

3. If changes exist:
   - Get issue title from Linear for commit message:
     ```
     skill: linear-issue
     args: get ID={ISSUE_ID}
     ```
   - Stage all changes:
     ```bash
     git add -A
     ```
   - Create commit with issue reference:
     ```bash
     git commit -m "{ISSUE_ID}: {issue_title}"
     ```
   - Log: "Created commit: {commit_hash}"

#### 4.2. Push to Remote

1. Check if local branch has unpushed commits:
   ```bash
   git status -sb
   ```
   Look for `[ahead N]` in output

2. If not ahead (no unpushed commits):
   - Log: "Branch is in sync with remote, skipping push"
   - Continue to next step

3. If ahead or no upstream:
   - Check if upstream exists:
     ```bash
     git rev-parse --abbrev-ref @{upstream} 2>/dev/null
     ```
   - If no upstream, push with `-u`:
     ```bash
     git push -u origin {current_branch}
     ```
   - If upstream exists:
     ```bash
     git push
     ```
   - Log: "Pushed to remote"

#### 4.3. Create Pull Request (Feature Branch Only)

> Skip this step if in Default branch mode

1. Check if PR already exists for current branch:
   ```bash
   gh pr list --head {current_branch} --state open --json number
   ```

2. If PR exists (non-empty JSON array):
   - Extract PR number and URL
   - Log: "PR already exists: #{pr_number}"
   - Continue to next step

3. If no PR exists:
   - Get issue details for PR description:
     ```
     skill: linear-issue
     args: get ID={ISSUE_ID}
     ```
   - Create PR:
     ```bash
     gh pr create --base {BASE_BRANCH} --title "{ISSUE_ID}: {issue_title}" --body "Resolves {ISSUE_ID}

     ## Summary
     {issue_description_summary}

     ## Linear Issue
     {linear_issue_url}"
     ```
   - Log: "Created PR: {pr_url}"

### 5. Update Linear Issue State

1. Determine target state based on branch type:
   - **Feature branch**: Target state = "In Review"
   - **Default branch**: Target state = "Done"

2. Get current issue state:
   ```
   skill: linear-issue
   args: get ID={ISSUE_ID}
   ```

3. If current state == target state:
   - Log: "Issue already in {target_state}, skipping update"
   - Continue to report

4. Get state ID for target state:
   ```
   skill: linear-state
   args: list ISSUE_ID={ISSUE_ID} NAME={target_state}
   ```

5. Update issue state:
   ```
   skill: linear-issue
   args: update ID={ISSUE_ID} STATE_ID={state_id}
   ```

6. Log: "Updated issue state to {target_state}"

### 6. Report Result

Output the final result to user.

## Output Format

### Success Output

```markdown
## Finalize Implementation Complete

- **Issue**: {ISSUE_ID}
- **Branch**: {branch_name} ({branch_type})
- **Status**: Success

### Operations Performed

| Operation | Status | Details |
|-----------|--------|---------|
| Commit | {Created/Skipped} | {commit_hash or "No changes"} |
| Push | {Pushed/Skipped} | {branch_name or "Already synced"} |
| Pull Request | {Created/Skipped/N/A} | {pr_url or reason} |
| Linear State | {Updated/Skipped} | {new_state or "Already in state"} |

### Result

- **PR URL**: {pr_url} (if feature branch)
- **Linear Issue**: {linear_url}
- **Final State**: {state_name}
```

### Cancelled Output

```markdown
## Finalize Implementation Cancelled

Finalization was cancelled by user.
No changes were made.
```

### Failure Output

```markdown
## Finalize Implementation Failed

- **Issue**: {ISSUE_ID}
- **Stage**: {stage where failure occurred}

### Error

{Error description}

### Operations Completed Before Failure

| Operation | Status |
|-----------|--------|
| Commit | {status} |
| Push | {status} |
| Pull Request | {status} |
| Linear State | {status} |

### Suggestion

{Recommended action to resolve}
```

## Idempotency Guarantees

This skill is designed to be safely re-run:

| Operation | Idempotency Check | Behavior if Already Done |
|-----------|-------------------|--------------------------|
| Commit | `git status --porcelain` empty | Skip, log "No uncommitted changes" |
| Push | No `[ahead N]` in status | Skip, log "Already synced" |
| PR Creation | `gh pr list --head` returns PR | Skip, log existing PR URL |
| State Update | Current state == target state | Skip, log "Already in state" |

## Quality Checklist

Before completing, verify:

- [ ] **Parameters validated**: ISSUE_ID is provided
- [ ] **User approval obtained**: User confirmed (or AUTO_ACCEPT=true)
- [ ] **Branch type detected**: Correctly identified as feature or default branch
- [ ] **Git operations idempotent**: Each step checked state before acting
- [ ] **Linear state updated**: Issue moved to correct state based on branch type
- [ ] **Result reported**: Summary of all operations provided to user

## Notice

### Dependent Skills

This skill requires the following skills:
- `linear-issue` - Get/update Linear issue details
- `linear-state` - Get workflow state IDs

### Git Requirements

- Must be run in a git repository
- Remote `origin` must be configured
- `gh` CLI must be authenticated for PR creation

### Error Handling

If any git operation fails:
1. Log the error with details
2. Report partial completion status
3. Provide suggestion for manual resolution
4. Do NOT attempt rollback (operations are safe to retry)
